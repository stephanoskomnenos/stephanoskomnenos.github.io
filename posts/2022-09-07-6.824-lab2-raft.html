<!doctype html>
<html lang="en" class="h-full">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Teahouse Smyrna - 6.824 Lab 2 Raft (2A-2C)</title>
    <link rel="stylesheet" href="../css/tailwind.css" />
    <link rel="stylesheet" href="../css/tailwind-extra.css" />
    <link rel="stylesheet" href="../css/syntax.css" />
    <!-- google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>

<body class="h-full bg-neutral-200 text-neutral-700 dark:bg-neutral-800 dark:text-neutral-300">

    <section class="sticky top-0 py-2 w-full shadow sm:py-4 bg-inherit">

        <div class="flex flex-row justify-between items-center px-6 mx-auto max-w-3xl">
            <div class="flex-1 justify-start">
                <div class="flex flex-shrink-0 items-center text-2xl">
                    <a href="../index.html" class="title-logo">
                        Teahouse Smyrna
                    </a>
                </div>
            </div>

            <div class="flex flex-row justify-end space-x-2 font-mono font-light sm:space-x-10 sm:font-normal flex-0">
                <a href="../" class="menu-link">
                    Home
                </a>
                <a href="../posts/page/1/index.html" class="menu-link">
                    Posts
                </a>
                <a href="../about.html" class="menu-link">
                    About
                </a>
            </div>
        </div>

    </section>


    <section class="justify-center items-start px-6 pb-8 mx-auto mt-2 max-w-3xl sm:mt-4 md:rounded">
        <div class="pt-2 sm:pt-4"></div>

        
        <p id="page-title" class="page-title">
            6.824 Lab 2 Raft (2A-2C)
        </p>
        

        <p class="font-mono font-normal sm:text-lg text-start">
    September  7, 2022
    
</p>
<div class="pb-2 font-normal sm:pb-8 sm:font-mono row">

    
    <span class="text-sm">
        Tags:
    </span>
    

    
    <a href="../tags/6.824.html" class="text-sm">
        6.824
    </a>
    
    <a href="../tags/distributed system.html" class="text-sm">
        distributed system
    </a>
    

</div>
<section class="font-sans text-sm sm:text-base prose lg:prose-xl">
    <h1 id="a-leader-election">2A: Leader Election</h1>
<p>2A 部分需要完成选举和 leader 发送心跳。</p>
<p><strong>关键步骤在 Figure 2 上有非常详细的指示，一定要全部看完。</strong></p>
<h2 id="流程概述">流程概述</h2>
<ul>
<li><p>启动时上层 tester 调用 <code class="verbatim">Make()</code> ，每个 raft 实例都初始化为 follower，并各自随机设定 election timeout。</p></li>
<li><p>到达 election timeout 后，raft 实例转化为 candidate，发起选举，设置 <code class="verbatim">currentTerm</code> 自增 1，并向其他实例发送 RequestVote RPC 请求投票，
若得票过半则转化为 leader。</p></li>
<li><p>实例收到投票请求时，对符合条件（详见 Figure 2）的候选人投票。</p></li>
<li><p>Leader 需要定时向其余实例发送 AppendEntries RPC 作为心跳包。</p></li>
<li><p>对所有实例：若收到 RPC request 或 reply 中 term <code class="verbatim">T</code> 大于 <code class="verbatim">currentTerm</code> ，则更新 <code class="verbatim">currentTerm</code> 为 <code class="verbatim">T</code> ，并转化为 follower。</p></li>
</ul>
<h2 id="定时器以及主循环">定时器以及主循环</h2>
<p>这里用到了两个 <code class="verbatim">time.Timer</code> ，分别控制选举和心跳。主循环（即 <code class="verbatim">ticker()</code> ）内使用 <code class="verbatim">select case</code> 语句读取 timer channel，
执行对应操作。（实验指导不建议用 <code class="verbatim">time.Timer</code> ，这里并没有按照指示）</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> <span class="op">(</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  HeartbeatInterval    <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> time<span class="op">.</span>Millisecond</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  ElectionBaseInterval <span class="op">=</span> <span class="dv">1500</span> <span class="op">*</span> time<span class="op">.</span>Millisecond</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> heartbeatDuration<span class="op">()</span> time<span class="op">.</span>Duration <span class="op">{</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> HeartbeatInterval</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> electionRandomDuration<span class="op">()</span> time<span class="op">.</span>Duration <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  rand<span class="op">.</span>Seed<span class="op">(</span>time<span class="op">.</span>Now<span class="op">().</span>UnixMicro<span class="op">())</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ElectionBaseInterval <span class="op">+</span> time<span class="op">.</span>Millisecond<span class="op">*</span>time<span class="op">.</span>Duration<span class="op">(</span>rand<span class="op">.</span>Intn<span class="op">(</span><span class="dv">150</span><span class="op">))</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>rf <span class="op">*</span>Raft<span class="op">)</span> ticker<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> rf<span class="op">.</span>killed<span class="op">()</span> <span class="op">==</span> <span class="ot">false</span> <span class="op">{</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">&lt;-</span>rf<span class="op">.</span>electionTimer<span class="op">.</span>C<span class="op">:</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>      rf<span class="op">.</span>mu<span class="op">.</span>Lock<span class="op">()</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>      rf<span class="op">.</span>convertTo<span class="op">(</span>RfCandidate<span class="op">)</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>      rf<span class="op">.</span>currentTerm <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>      rf<span class="op">.</span>startElection<span class="op">()</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>      rf<span class="op">.</span>electionTimer<span class="op">.</span>Reset<span class="op">(</span>electionRandomDuration<span class="op">())</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>      rf<span class="op">.</span>mu<span class="op">.</span>Unlock<span class="op">()</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">&lt;-</span>rf<span class="op">.</span>heartbeatTimer<span class="op">.</span>C<span class="op">:</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>      rf<span class="op">.</span>mu<span class="op">.</span>Lock<span class="op">()</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> rf<span class="op">.</span>state <span class="op">==</span> RfLeader <span class="op">{</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        rf<span class="op">.</span>broadcastHeartbeat<span class="op">()</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>      rf<span class="op">.</span>mu<span class="op">.</span>Unlock<span class="op">()</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>另外，在 <code class="verbatim">broadcastHeartbeat()</code> 末尾重设 heartbeatTimer，在 <code class="verbatim">RequestVote()</code> 确认投票时以及转化为 leader 时重设 electionTimer。</p>
<h1 id="b-log">2B: Log</h1>
<p>在 2A 基础上加入日志操作：</p>
<ul>
<li>Leader 上任时将除自己之外的每个实例的 <code class="verbatim">matchIndex</code> 设为 0， <code class="verbatim">nextIndex</code> 设为 <code class="verbatim">len(log)</code> 。</li>
<li>Leader 通过 AppendEntries 发送新日志，follower 经过检查后决定是否追加这部分日志。</li>
<li>Leader 收到 follower 已追加日志的回复后，更新 <code class="verbatim">matchIndex[follower]</code> 及 <code class="verbatim">nextIndex[follower]</code> ，若符合条件（见 Figure 2）更新
<code class="verbatim">commitIndex</code> 。</li>
<li>Leader 的追加日志请求若被拒绝，则降低 <code class="verbatim">nextIndex[follower]</code> 。</li>
<li>RequestVote 中加入对候选人日志的检查。</li>
<li>对所有实例：若 <code class="verbatim">commitIndex &gt; lastApplied</code> ，则发送 <code class="verbatim">log[lastApplied+1:commitIndex+1]</code> 到上层 server（即 tester），
并更新 <code class="verbatim">lastApplied = commitIndex</code> 。</li>
</ul>
<h2 id="注意事项">注意事项</h2>
<ul>
<li>在身份可能被别的 goroutine 改变时（即释放锁再重新获得锁之后），先确认身份再执行操作。</li>
<li>Leader 追加日志请求被拒绝时降低 <code class="verbatim">nextIndex</code> 的方式如果时每次减 1，则效率太低，可能通不过 2C 的测试。
<a href="https://thesquareplanet.com/blog/students-guide-to-raft/#an-aside-on-optimizations">Students’ Guide to Raft</a> 给出了优化方法。</li>
</ul>
<h2 id="日志提交">日志提交</h2>
<p>对所有实例：若 <code class="verbatim">commitIndex &gt; lastApplied</code> ，则调用 <code class="verbatim">sendApplyMsg()</code> ，
发送 <code class="verbatim">log[lastApplied+1:commitIndex+1]</code> 到上层 server（即 tester），并更新 <code class="verbatim">lastApplied = commitIndex</code> 。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ApplyMsg <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a> CommandValid <span class="dt">bool</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a> Command      <span class="kw">interface</span><span class="op">{}</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a> CommandIndex <span class="dt">int</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a> <span class="co">// For 2D:</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a> SnapshotValid <span class="dt">bool</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a> Snapshot      <span class="op">[]</span><span class="dt">byte</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a> SnapshotTerm  <span class="dt">int</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a> SnapshotIndex <span class="dt">int</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>rf <span class="op">*</span>Raft<span class="op">)</span> sendApplyMsg<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a> rf<span class="op">.</span>applyMu<span class="op">.</span>Lock<span class="op">()</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a> <span class="cf">defer</span> rf<span class="op">.</span>applyMu<span class="op">.</span>Unlock<span class="op">()</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a> rf<span class="op">.</span>mu<span class="op">.</span>Lock<span class="op">()</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a> lastApplied <span class="op">:=</span> rf<span class="op">.</span>lastApplied</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a> logs <span class="op">:=</span> <span class="bu">make</span><span class="op">([]</span>LogEntry<span class="op">,</span> rf<span class="op">.</span>commitIndex<span class="op">-</span>rf<span class="op">.</span>lastApplied<span class="op">)</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a> <span class="bu">copy</span><span class="op">(</span>logs<span class="op">,</span> rf<span class="op">.</span>log<span class="op">[</span>rf<span class="op">.</span>lastApplied<span class="op">+</span><span class="dv">1</span><span class="op">:</span>rf<span class="op">.</span>commitIndex<span class="op">+</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a> rf<span class="op">.</span>lastApplied <span class="op">+=</span> <span class="bu">len</span><span class="op">(</span>logs<span class="op">)</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a> DPrintf<span class="op">(</span><span class="st">&quot;ApplyMsg: raft %d sending logs from index %d to %d&quot;</span><span class="op">,</span> rf<span class="op">.</span>me<span class="op">,</span> lastApplied<span class="op">+</span><span class="dv">1</span><span class="op">,</span> rf<span class="op">.</span>commitIndex<span class="op">)</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a> rf<span class="op">.</span>mu<span class="op">.</span>Unlock<span class="op">()</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a> <span class="cf">for</span> i<span class="op">,</span> log <span class="op">:=</span> <span class="kw">range</span> logs <span class="op">{</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  applyMsg <span class="op">:=</span> ApplyMsg<span class="op">{</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>   CommandValid<span class="op">:</span> <span class="ot">true</span><span class="op">,</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>   Command<span class="op">:</span>      log<span class="op">.</span>Command<span class="op">,</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>   CommandIndex<span class="op">:</span> lastApplied <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> i<span class="op">,</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  DPrintf<span class="op">(</span><span class="st">&quot;ApplyMsg: raft %d, send log with index %d&quot;</span><span class="op">,</span> rf<span class="op">.</span>me<span class="op">,</span> lastApplied<span class="op">+</span><span class="dv">1</span><span class="op">+</span>i<span class="op">)</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  rf<span class="op">.</span>applyCh <span class="op">&lt;-</span> applyMsg</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="nextindex-回溯查找的优化方法"><code class="verbatim">nextIndex</code> 回溯查找的优化方法</h2>
<blockquote>
<ul>
<li>If a follower does not have <code class="verbatim">prevLogIndex</code> in its log, it should return with <code class="verbatim">conflictIndex = len(log)</code> and <code class="verbatim">conflictTerm = None</code> .</li>
<li>If a follower does have <code class="verbatim">prevLogIndex</code> in its log, but the term does not match, it should return <code class="verbatim">conflictTerm = log[prevLogIndex].Term</code> , and then search its log for the first index whose entry has term equal to <code class="verbatim">conflictTerm</code>.</li>
<li>Upon receiving a conflict response, the leader should first search its log for <code class="verbatim">conflictTerm</code>. If it finds an entry in its log with that term, it should set nextIndex to be the one beyond the index of the last entry in that term in its log.</li>
<li>If it does not find an entry with that term, it should set <code class="verbatim">nextIndex = conflictIndex</code>.</li>
</ul>
</blockquote>
<p>这里实现了简化版本，即只有 <code class="verbatim">conflictIndex</code> 。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// in AppendEntries()</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>conflictTerm <span class="op">:=</span> rf<span class="op">.</span>log<span class="op">[</span>args<span class="op">.</span>PrevLogIndex<span class="op">].</span>Term</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>reply<span class="op">.</span>ConflictIndex <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>rf<span class="op">.</span>log <span class="op">=</span> rf<span class="op">.</span>log<span class="op">[:</span>args<span class="op">.</span>PrevLogIndex<span class="op">]</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i<span class="op">,</span> logEntry <span class="op">:=</span> <span class="kw">range</span> rf<span class="op">.</span>log <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> logEntry<span class="op">.</span>Term <span class="op">==</span> conflictTerm <span class="op">{</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    reply<span class="op">.</span>ConflictIndex <span class="op">=</span> i</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// in broadcastHeartbeat()</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> reply<span class="op">.</span>ConflictIndex <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span> <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  rf<span class="op">.</span>nextIndex<span class="op">[</span>follower<span class="op">]</span> <span class="op">=</span> reply<span class="op">.</span>ConflictIndex</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1 id="c-persistence">2C: Persistence</h1>
<p>2C 的任务本身比较简单，即在需要持久化的状态改变时执行 <code class="verbatim">persist()</code> 。</p>
<p>然而 2C 的测试比较严格，会将之前的一些问题暴露出来，导致需要从命令行输出中找 bug。这是个非常痛苦的过程。</p>
<p>这里推荐一个并行执行测试的脚本： <a href="https://gist.github.com/jonhoo/f686cacb4b9fe716d5aa">go-test-many.sh</a></p>
</section>

<div id="gitalk-container" class="pt-10"></div>
<script>
var gitalk = new Gitalk({
  clientID: 'f6529c11f069742b9e4f',
  clientSecret: '0badcf70dc4fe1fb135c8ac95dcfc31bea6f590e',
  repo: 'blog-comments',
  owner: 'AnatolyKomninov',
  admin: ['AnatolyKomninov', 'stephanoskomnenos'],
  id: location.pathname,      // Ensure uniqueness and length less than 50
  distractionFreeMode: false  // Facebook-like distraction free mode
})
gitalk.render('gitalk-container')
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by Gitalk.</a></noscript>

    </section>

    <footer class="bottom-0 w-full h-8 text-sm sm:h-14 sm:text-sm">
        <div class="font-mono text-center">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll" class="italic">Hakyll</a>
        </div>
    </footer>
</body>

</html>
